<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Music Protection - Sign In</title>
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Arial', sans-serif;
    }

    body {
      background: #f8f4f0;
      color: #652612;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      padding: 20px;
    }

    .auth-container {
      background: rgba(255, 255, 255, 0.95);
      border-radius: 12px;
      box-shadow: 0 8px 30px rgba(101, 38, 18, 0.15);
      width: 100%;
      max-width: 400px;
      padding: 30px;
      text-align: center;
    }

    .logo {
      font-size: 2.5rem;
      margin-bottom: 20px;
      color: #652612;
    }

    h2 {
      margin-bottom: 20px;
      font-size: 1.8rem;
    }

    p {
      margin-bottom: 25px;
      color: #7e4935;
    }

    .form-group {
      margin-bottom: 20px;
      text-align: left;
    }

    label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
    }

    input {
      width: 100%;
      padding: 12px 15px;
      border: 2px solid #d2c0ac;
      border-radius: 8px;
      font-size: 16px;
      transition: border-color 0.3s;
    }

    input:focus {
      border-color: #652612;
      outline: none;
    }

    button {
      width: 100%;
      padding: 14px;
      background: #652612;
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.3s;
    }

    button:hover {
      background: #7e4935;
    }

    .message {
      margin-top: 20px;
      padding: 12px;
      border-radius: 8px;
      display: none;
    }

    .success {
      background: #e6f7ee;
      color: #2e7d52;
      border: 1px solid #2e7d52;
    }

    .error {
      background: #feecf0;
      color: #d32f2f;
      border: 1px solid #d32f2f;
    }

    .error-details {
      margin-top: 10px;
      font-size: 0.85rem;
      text-align: left;
      background: rgba(211, 47, 47, 0.1);
      padding: 8px;
      border-radius: 4px;
      display: none;
    }

    .toggle-error {
      color: #d32f2f;
      text-decoration: underline;
      cursor: pointer;
      font-size: 0.85rem;
      margin-top: 5px;
      display: inline-block;
    }

    .loader {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      border-top-color: white;
      animation: spin 1s ease-in-out infinite;
      display: none;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    @media (max-width: 480px) {
      .auth-container {
        padding: 20px;
      }
      
      button {
        padding: 12px;
      }
    }
  </style>
</head>
<body>
  <div class="auth-container">
    <div class="logo">ðŸŽµ</div>
    <h2>Welcome to OFek</h2>
    <p>Sigup / Login to protect your creative work and revenue</p>
    
    <form id="authForm">
      <div class="form-group">
        <label for="email">Email</label>
        <input type="email" id="email" placeholder="Your email address" required>
      </div>
      
      <div class="form-group">
        <label for="password">Password</label>
        <input type="password" id="password" placeholder="Your password" required>
      </div>
      
      <button type="submit" id="submitBtn">
        <span id="btnText">Continue</span>
        <div class="loader" id="loader"></div>
      </button>
    </form>
    
    <div class="message" id="message"></div>
    <div class="error-details" id="errorDetails"></div>
  </div>

  <script>
    // Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyAhlC-1LJYn4De0fL3iJhwtDWRzDpCwXaY",
      authDomain: "vouchcard-46e48.firebaseapp.com",
      databaseURL: "https://vouchcard-46e48-default-rtdb.firebaseio.com",
      projectId: "vouchcard-46e48",
      storageBucket: "vouchcard-46e48.firebasestorage.app",
      messagingSenderId: "951045666666",
      appId: "1:951045666666:web:35a4808d943ae311565713",
      measurementId: "G-0PDX1RFQ02"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const database = firebase.database();

    // Function to save user data to Realtime Database
    function saveUserData(user) {
      const userData = {
        email: user.email,
        uid: user.uid,
        createdAt: new Date().toISOString(),
        lastLogin: new Date().toISOString()
      };
      
      return database.ref('users/' + user.uid).set(userData)
        .then(() => {
          console.log("User data saved successfully!");
          return true;
        })
        .catch((error) => {
          console.error("Error saving user data:", error);
          throw error;
        });
    }

    // Error logging function
    function logError(error, context) {
      const timestamp = new Date().toISOString();
      const errorMessage = error.message || error.toString();
      const errorCode = error.code || 'N/A';
      
      // Log to console
      console.error(`[${timestamp}] Error in ${context}:`, error);
      console.error(`Error Code: ${errorCode}, Message: ${errorMessage}`);
      
      return { timestamp, context, errorCode, errorMessage };
    }

    // Function to check if a user exists with the provided email
    function checkUserExists(email) {
      return auth.fetchSignInMethodsForEmail(email)
        .then((signInMethods) => {
          return signInMethods.length > 0;
        })
        .catch((error) => {
          logError(error, 'fetchSignInMethodsForEmail');
          return false;
        });
    }

    // Handle form submission
    document.getElementById('authForm').addEventListener('submit', function(e) {
      e.preventDefault();
      
      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;
      const submitBtn = document.getElementById('submitBtn');
      const btnText = document.getElementById('btnText');
      const loader = document.getElementById('loader');
      const message = document.getElementById('message');
      const errorDetails = document.getElementById('errorDetails');
      
      // Hide previous error details
      errorDetails.style.display = 'none';
      errorDetails.textContent = '';
      
      // Show loading state
      btnText.style.display = 'none';
      loader.style.display = 'inline-block';
      submitBtn.disabled = true;
      message.style.display = 'none';
      
      // First try to sign in
      auth.signInWithEmailAndPassword(email, password)
        .then((userCredential) => {
          // Update last login timestamp
          const user = userCredential.user;
          database.ref('users/' + user.uid).update({
            lastLogin: new Date().toISOString()
          });
          
          // Signed in successfully
          showMessage('Successfully signed in! Redirecting...', 'success');
          // Log successful sign in
          console.log(`User ${userCredential.user.email} signed in successfully`);
          // Redirect to dashboard or home page
          setTimeout(() => {
            window.location.href = 'dashboard.html';
          }, 1500);
        })
        .catch(async (signInError) => {
          // Log the sign in error
          const errorInfo = logError(signInError, 'signInWithEmailAndPassword');
          
          // Check if the error is due to invalid credentials
          if (signInError.code === 'auth/invalid-login-credentials') {
            try {
              // Check if the user exists before trying to create a new account
              const userExists = await checkUserExists(email);
              
              if (userExists) {
                // User exists but credentials are wrong
                showMessage('Invalid email or password. Please try again.', 'error', errorInfo);
                resetButton();
              } else {
                // User doesn't exist, so create a new account
                auth.createUserWithEmailAndPassword(email, password)
                  .then((userCredential) => {
                    // Save user data to database
                    return saveUserData(userCredential.user)
                      .then(() => {
                        showMessage('Account created successfully! Redirecting...', 'success');
                        // Log successful account creation
                        console.log(`New account created for ${userCredential.user.email}`);
                        // Redirect to dashboard or home page
                        setTimeout(() => {
                          window.location.href = 'dashboard.html';
                        }, 1500);
                      });
                  })
                  .catch((signUpError) => {
                    // Log the sign up error
                    const signUpErrorInfo = logError(signUpError, 'createUserWithEmailAndPassword');
                    showMessage(getErrorMessage(signUpError), 'error', signUpErrorInfo);
                    resetButton();
                  });
              }
            } catch (error) {
              // Error checking user existence
              const checkErrorInfo = logError(error, 'checkUserExists');
              showMessage('An error occurred. Please try again.', 'error', checkErrorInfo);
              resetButton();
            }
          } else {
            // Other sign in errors
            showMessage(getErrorMessage(signInError), 'error', errorInfo);
            resetButton();
          }
        });
        
      function resetButton() {
        btnText.style.display = 'inline-block';
        loader.style.display = 'none';
        submitBtn.disabled = false;
      }
      
      function showMessage(text, type, errorInfo = null) {
        message.textContent = text;
        message.className = 'message ' + type;
        message.style.display = 'block';
        
        // If it's an error and we have error info, show details toggle
        if (type === 'error' && errorInfo) {
          // Remove any existing toggle
          const existingToggle = message.querySelector('.toggle-error');
          if (existingToggle) {
            existingToggle.remove();
          }
          
          const toggle = document.createElement('div');
          toggle.className = 'toggle-error';
          toggle.textContent = 'Show error details';
          toggle.onclick = function() {
            if (errorDetails.style.display === 'none') {
              errorDetails.innerHTML = `
                <strong>Error Details:</strong><br>
                Time: ${errorInfo.timestamp}<br>
                Context: ${errorInfo.context}<br>
                Code: ${errorInfo.errorCode}<br>
                Message: ${errorInfo.errorMessage}
              `;
              errorDetails.style.display = 'block';
              toggle.textContent = 'Hide error details';
            } else {
              errorDetails.style.display = 'none';
              toggle.textContent = 'Show error details';
            }
          };
          
          message.appendChild(toggle);
        }
      }
      
      function getErrorMessage(error) {
        switch (error.code) {
          case 'auth/email-already-in-use':
            return 'This email is already registered.';
          case 'auth/invalid-email':
            return 'Please enter a valid email address.';
          case 'auth/weak-password':
            return 'Password should be at least 6 characters.';
          case 'auth/wrong-password':
          case 'auth/invalid-login-credentials':
            return 'Invalid email or password. Please try again.';
          case 'auth/too-many-requests':
            return 'Too many failed attempts. Please try again later.';
          case 'auth/network-request-failed':
            return 'Network error. Please check your connection.';
          default:
            return 'An error occurred. Please try again.';
        }
      }
    });
  </script>
</body>
</html>